#!/usr/bin/env bash

source "${HOME}/bin/common.sh"

update_go() {
  local os
  os="$(uname)"

  if [[ "${os}" != "Linux" ]]; then return; fi

  info "Updating go"

  gover="$(curl https://go.dev/VERSION?m=text 2>/dev/null)"
  if [[ -d "/usr/local/${gover}" ]]; then
    go version
    success
    return
  fi

  local arch="arm64"
  if [[ "$(uname -m)" == "x86_64" ]]; then
    arch="amd64"
  fi
  local pkg="${gover}.${os}-${arch}.tar.gz"

  curl -sSL "https://go.dev/dl/${pkg}" --output "${HOME}/Downloads/${pkg}" >/dev/null 2>&1
  sudo rm -f /usr/local/go
  sudo tar -C /usr/local -xzf "${HOME}/Downloads/${pkg}"
  sudo mv /usr/local/go "/usr/local/${gover}"
  sudo ln -sf "/usr/local/${gover}" /usr/local/go
  go version

  success
}

update_fly() {
  if command -v flyctl &>/dev/null; then
    info "Updating flyctl"
    curl -L https://fly.io/install.sh 2>/dev/null | sh >/dev/null 2>&1
    flyctl version
    success
  fi
}

update() {
  if command -v brew &>/dev/null; then
    info "Updating brew packages"
    brew update && brew upgrade
    success
  fi

  if command -v apt &>/dev/null; then
    info "Updating apt packages"
    sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y
    success
  fi
}

update_go
update_fly
update
